= Lab 9: RHACS Log4Shell Vulnerability Detection and Prevention

== Learning objectives

By the end of this lab, you will be able to:

* Deploy applications with known vulnerabilities (Log4Shell CVE-2021-44228) for testing
* Use RHACS to scan and detect critical vulnerabilities in running containers
* Configure RHACS policies to block vulnerable deployments at build and deploy time
* Understand RHACS violation lifecycle across build, deploy, and runtime stages
* Implement policy enforcement to prevent high-severity CVEs from reaching production
* Review security policy violations and take remediation actions

== Value proposition

*For field teams*: This lab demonstrates RHACS's ability to detect and prevent the Log4Shell vulnerability, one of the most critical security threats in recent history. Use this to show how RHACS would have protected customers from this widespread attack that affected thousands of organizations.

*Customer proof points*:

* *Zero-day protection*: RHACS detected Log4Shell (CVE-2021-44228) immediately upon disclosure, protecting customers before exploits emerged
* *Multi-stage prevention*: Block vulnerable images at build time, deployment time, and runtime for defense-in-depth
* *Business continuity*: Prevent security incidents that caused average downtime of 21 days and $4.35M in costs for affected organizations^1^
* *Rapid response*: Policy-based enforcement allows security teams to block new vulnerabilities across all clusters within minutes

^1^ https://www.ibm.com/security/data-breach[IBM Cost of a Data Breach Report^] - Average breach costs

== Introduction

This lab shows how to block workloads with Log4Shell vulnerabilities using Red Hat Advanced Cluster Security (RHACS).

**RHACS Console Credentials:**

[cols="1,2"]
|===
| *RHACS Console URL* | `{acs_route}`
| *Username* | `{acs_portal_username}`
| *Password* | `{acs_portal_password}`
|===

.Goals
* Block the vulnerable deployment of a log4shell application
* Craft a policy to block the deployment of any application that uses log4shell
* Verify the policy in the RHACS console


== 1. Deploy Vulnerable Application

Create a new project and deploy the vulnerable Log4Shell app:

[source,sh,role=execute]
----
oc new-project log4shell
cat << EOF > ~/deploy.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: log4shell
  namespace: log4shell
spec:
  replicas: 1
  selector:
    matchLabels:
      deployment: log4shell
  template:
    metadata:
      labels:
        deployment: log4shell
    spec:
      containers:
      - name: log4shell
        image: quay.io/rhacs-misc/log4shell:1.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 8080
          protocol: TCP
      restartPolicy: Always
EOF
oc create -f ~/deploy.yaml
----

Check the pod status:

[source,sh,role=execute]
----
oc get pods -l deployment=log4shell -n log4shell
----

NOTE: You can add -w to the command to watch the pod status.

[.console-output]
[source,sh]
----
[lab-user@bastion ~]$ oc get pods -l deployment=log4shell -n log4shell
NAME                         READY   STATUS              RESTARTS   AGE
log4shell-6454cfb8c9-whskt   0/1     ContainerCreating   0          9s
log4shell-6454cfb8c9-whskt   1/1     Running             0          12s
----


== 2. Verify Vulnerability

Scan the image to confirm the Log4Shell vulnerability is present:

[source,sh,role=execute]
----
roxctl --insecure-skip-tls-verify -e "$ROX_CENTRAL_ADDRESS:443" image scan --image=quay.io/rhacs-misc/log4shell:1.0 --force -o table --severity=CRITICAL
----

[.console-output]
[source,sh]
----
Scan results for image: quay.io/rhacs-misc/log4shell:1.0
(TOTAL-COMPONENTS: 5, TOTAL-VULNERABILITIES: 4, LOW: 0, MODERATE: 0, IMPORTANT: 0, CRITICAL: 4)

+------------------------------------------------+---------+----------------+----------+------+---------------------------------------------------+---------------+----------+---------------+
|                   COMPONENT                    | VERSION |      CVE       | SEVERITY | CVSS |                       LINK                        | FIXED VERSION | ADVISORY | ADVISORY LINK |
+------------------------------------------------+---------+----------------+----------+------+---------------------------------------------------+---------------+----------+---------------+
|      org.apache.logging.log4j:log4j-core       | 2.14.1  | CVE-2021-44228 | CRITICAL |  10  | https://osv.dev/vulnerability/GHSA-jfh8-c2jp-5v3q |    2.15.0     |    -     |       -       |
|                                                |         +----------------+----------+------+---------------------------------------------------+---------------+----------+---------------+
|                                                |         | CVE-2021-45
.
.
.
WARN:   A total of 4 unique vulnerabilities were found in 5 components
----

Look for CVE-2021-44228 in the output. It should be at the top of the list.

== 3. Review the Vulnerability in the RHACS Console

Quickly identifying a vulnerability with RHACS enables you to proactively protect your workloads, minimize risk, and respond to security threats before they can be exploited.

1. In the RHACS console, go to the **Results** page under the vulnerability management tab.

image::BH-log4shell-00.png[link=self, window=blank, width=100%]

[start=2]
2. Filter for the Log4Shell CVE (CVE-2021-44228).

image::BH-log4shell-01.png[link=self, window=blank, width=100%]

[start=3]
3. Click on the CVE-2021-44228 vulnerability to see the details.

image::BH-log4shell-02.png[link=self, window=blank, width=100%]

[start=4]
4. Click on the **quay.io/rhacs-misc/log4shell:1.0** tab to see the workload you deployed.

image::BH-log4shell-03.png[link=self, window=blank, width=100%]

== 4. Apply Policy to Block Log4Shell at the build, deploy and runtime stages

Below, you will be deploying one policy that will block the log4shell vulnerability.

This policy blocks images containing the vulnerable Log4j version at build, deploy, and runtime. Execute the following commands to create the policy in the stackrox namespace:

[source,sh,role=execute]
----
cat <<EOF > block-log4shell-policy.yaml
apiVersion: config.stackrox.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: block-log4shell-cve-2021-44228
spec:
  policyName: block-log4shell-cve-2021-44228
  description: |
    Blocks deployments containing the Log4Shell (CVE-2021-44228) vulnerability in Log4j.
    This policy helps prevent exploitation of a critical remote code execution vulnerability
    in affected versions of the Log4j library.
  rationale: |
    The Log4Shell vulnerability (CVE-2021-44228) is a critical security issue in the Log4j
    library that allows remote code execution and has been widely exploited. Blocking deployments
    with this vulnerability reduces the risk of compromise and lateral movement in your cluster.
  remediation: |
    Update your application dependencies to use Log4j version 2.15.0 or later, which contains
    the fix for CVE-2021-44228. Rebuild and redeploy your application images after updating.
  categories:
    - Vulnerability Management
  lifecycleStages:
    - BUILD
    - DEPLOY
  eventSource: NOT_APPLICABLE
  severity: CRITICAL_SEVERITY
  enforcementActions:
    - FAIL_BUILD_ENFORCEMENT
    - SCALE_TO_ZERO_ENFORCEMENT
    - UNSATISFIABLE_NODE_CONSTRAINT_ENFORCEMENT
  policySections:
    - sectionName: Rule 1
      policyGroups:
        - fieldName: CVE
          booleanOperator: OR
          values:
            - value: CVE-2021-44228
  criteriaLocked: false
  mitreVectorsLocked: false
  isDefault: false
EOF

oc apply -f block-log4shell-policy.yaml -n stackrox
----

== 5. Review Violations

1. In the RHACS console, go to the **Violations** page.

image::BH-violations-00.png[link=self, window=blank, width=100%]

[start=2]
2. You should see the log4shell policy at the top of the list.

image::BH-violations-01.png[link=self, window=blank, width=100%]

Awesome! So we know you've "enforced" the policy. However, the workload is still running. This is because ACS will not kill a running workload to avoid disrupting the application.

[source,sh,role=execute]
----
oc get pods -l deployment=log4shell -n log4shell
----

But if you try to redeploy the application, you will see the following error:

[source,sh,role=execute]
----
oc create -f ~/deploy.yaml
----

[.console-output]
[source,sh]
----
Error from server (Failed currently enforced policies from RHACS): error when creating "/home/lab-user/deploy.yaml": admission webhook "policyeval.stackrox.io" denied the request: 
The attempted operation violated 1 enforced policy, described below:

Policy: block-log4shell-cve-2021-44228
- Description:
    ↳ Blocks deployments containing the Log4Shell (CVE-2021-44228) vulnerability in
      Log4j.
      This policy helps prevent exploitation of a critical remote code execution
      vulnerability
      in affected versions of the Log4j library.
- Rationale:
    ↳ The Log4Shell vulnerability (CVE-2021-44228) is a critical security issue in the
      Log4j
      library that allows remote code execution and has been widely exploited.
      Blocking deployments
      with this vulnerability reduces the risk of compromise and lateral movement in
      your cluster.
- Remediation:
    ↳ Update your application dependencies to use Log4j version 2.15.0 or later, which
      contains
      the fix for CVE-2021-44228. Rebuild and redeploy your application images after
      updating.
- Violations:
    - CVE-2021-44228 (CVSS 10) (severity Critical) found in component 'org.apache.logging.log4j:log4j-core' (version 2.14.1) in container 'log4shell'

In case of emergency, add the annotation {"admission.stackrox.io/break-glass": "ticket-1234"} to your deployment with an updated ticket number
----

Congrats! Moving forward no applications will be able to deploy with the vulnerable Log4j version!

== Summary

Excellent work! You have successfully used RHACS to detect, prevent, and remediate the Log4Shell vulnerability.

=== What you accomplished

In this lab, you:

* ✅ Deployed an application with the Log4Shell vulnerability (CVE-2021-44228)
* ✅ Scanned container images to detect critical vulnerabilities using RHACS
* ✅ Reviewed vulnerability details in the RHACS console
* ✅ Created and enforced security policies to block vulnerable deployments
* ✅ Verified policy enforcement across build, deploy, and runtime stages
* ✅ Reviewed violations and understood remediation workflows

=== Key takeaways for customer conversations

* *Zero-day readiness*: RHACS detects new vulnerabilities immediately upon disclosure, before exploits are weaponized
* *Multi-stage enforcement*: Policies block vulnerabilities at build, deploy, and runtime for comprehensive protection
* *Business impact*: Prevented a vulnerability that affected 93% of cloud environments and caused billions in damages globally
* *Emergency override*: Break-glass annotation allows controlled deployments during incident response

=== Next steps

In the final lab, you will integrate ROSA with Amazon Cognito for enterprise identity provider (IdP) authentication, enabling single sign-on (SSO) for your cluster.
